const sports = [
  { key: 'nba',      label: 'NBA' },
  { key: 'lol',      label: 'League of Legends Esports' },
  { key: 'csgo',     label: 'CS2 / CSGO Esports' },
  { key: 'valorant', label: 'VALORANT Esports' }
];

const TRACK_POLL_MS = 500;
const REQUEST_TIMEOUT_MS = 8000;
const BULLET             = '\u2022';

const sectionsRoot = document.querySelector('#sections');
const template     = document.querySelector('#sport-template');
const themeToggle  = document.querySelector('#theme-toggle');
const globalRefreshEl = document.querySelector('#global-refresh-time');

const state = new Map();

function updateGlobalRefresh() {
  const d = new Date();
  const h = d.getHours() % 12 || 12;
  const m = String(d.getMinutes()).padStart(2, '0');
  const s = String(d.getSeconds()).padStart(2, '0');
  const ms = String(d.getMilliseconds()).padStart(3, '0').slice(0, 2);
  const ampm = d.getHours() >= 12 ? 'pm' : 'am';
  globalRefreshEl.textContent = `Refreshed at: ${h}:${m}:${s}:${ms} ${ampm}`;
}

const isLiveStatus = (s = '') => /\b(live|inprogress|in.?progress|ongoing|halftime)\b/i.test(s);

function formatPacificTime(isoValue) {
  if (!isoValue) return 'TBD';
  let date;
  try {
      if (typeof isoValue === 'string' && !isoValue.endsWith('Z') && !isoValue.includes('+') && !isoValue.includes('-')) {
          isoValue += 'Z';
      }
      date = new Date(isoValue);
  } catch { return 'TBD'; }
  if (!date || Number.isNaN(date.getTime())) return 'TBD';
  return new Intl.DateTimeFormat('en-US', {
    month: 'short', day: 'numeric',
    hour: 'numeric', minute: '2-digit', hour12: true,
    timeZone: 'America/Los_Angeles'
  }).format(date) + ' PT';
}

async function fetchWithTimeout(url, ms = REQUEST_TIMEOUT_MS) {
  const ctrl = new AbortController();
  const t    = setTimeout(() => ctrl.abort(), ms);
  try { return await fetch(url, { signal: ctrl.signal }); }
  finally { clearTimeout(t); }
}

async function safeJson(res) {
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { return { error: text?.slice(0, 180) || `HTTP ${res.status}` }; }
}

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  themeToggle.textContent = theme === 'dark' ? '\u2600\uFE0F Light mode' : '\uD83C\uDF19 Dark mode';
  localStorage.setItem('theme', theme);
}
function initTheme() { setTheme(localStorage.getItem('theme') === 'dark' ? 'dark' : 'light'); }

function renderTeam(container, name, code, score) {
  container.innerHTML = `<div class="abbr">${code || ''}</div><div>${name || 'TBD'}</div><div class="score">${score ?? '-'}</div>`;
}

function setActiveChip(sportKey, label) {
  const ss = state.get(sportKey);
  if (!ss) return;
  for (const chip of ss.root.querySelectorAll('.game-chip'))
    chip.classList.toggle('active', chip.dataset.label === label);
}

function updateStreamButton(ss, match) {
  if (!ss?.streamRow || !ss?.streamBtn) return;
  const url = typeof match?.streamUrl === 'string' ? match.streamUrl.trim() : '';
  ss.streamRow.hidden   = !url;
  ss.streamBtn.disabled = !url;
  ss.streamBtn.onclick = () => { if (url) window.open(url, '_blank', 'noopener,noreferrer'); };
}

function clearPolling(ss) {
  if (ss.pollTimer) { clearTimeout(ss.pollTimer); ss.pollTimer = null; }
}

function renderTrackedMatch(sportKey, data) {
  const ss = state.get(sportKey);
  if (!ss) return;

  updateGlobalRefresh();
  updateStreamButton(ss, data);

  if (sportKey === 'nba') {
    renderTeam(ss.awayEl, `${data.away.city} ${data.away.name}`, data.away.code, data.away.score);
    renderTeam(ss.homeEl, `${data.home.city} ${data.home.name}`, data.home.code, data.home.score);

    let cleanStatus = data.status;
    let clockText   = data.clock || '';

    if (cleanStatus === 'Final' && clockText === 'Final') clockText = '';

    ss.statusEl.textContent = cleanStatus;

    const isLive = isLiveStatus(data.status) || /Q\d|OT|Half|Live/i.test(data.status);
    const timeInfo = isLive ? '' : ` ${BULLET} ${formatPacificTime(data.startTime)}`;

    let displayClock = `${clockText}${timeInfo}`;
    if (!clockText && displayClock.startsWith(` ${BULLET} `)) {
        displayClock = displayClock.replace(` ${BULLET} `, '');
    }
    ss.clockEl.textContent = displayClock;
    return;
  }

  const parts = String(data.label || 'TBD vs TBD').split(/\s+vs\s+/i);
  const [s1, s2] = String(data.score || '0-0').split('-');

  renderTeam(ss.awayEl, parts[0] || 'TBD', '', s1 !== undefined ? s1 : '-');
  renderTeam(ss.homeEl, parts[1] || 'TBD', '', s2 !== undefined ? s2 : '-');

  // Status: league • Live/Scheduled • series info (Bo3: 1–0)
  const seriesPart = data.seriesScore ? ` ${BULLET} ${data.seriesScore}` : '';
  ss.statusEl.textContent = `${data.league || ''} ${BULLET} ${data.status || ''}${seriesPart}`;

  // Clock line: game elapsed time, then kills on same line if available
  let clockLine = data.gameTime || data.clock || formatPacificTime(data.startTime);
  if (data.kills) clockLine += `  |  ${data.kills}`;
  ss.clockEl.textContent = clockLine;
}

async function fetchTrack(sportKey, query, silent = false) {
  const ss = state.get(sportKey);
  if (!ss) return;
  try {
    const res     = await fetchWithTimeout(`/api/track?sport=${encodeURIComponent(sportKey)}&query=${encodeURIComponent(query)}`);
    const payload = await safeJson(res);
    if (!res.ok) {
      if (!silent) ss.errorEl.textContent = payload.error || 'Could not track game.';
      if (payload.warning) ss.helpEl.textContent = `Fallback: ${payload.warning}`;
      return;
    }
    renderTrackedMatch(sportKey, payload.match);
    ss.helpEl.textContent  = payload.warning ? `Fallback: ${payload.warning}` : 'Upcoming in next 12 hours:';
    ss.errorEl.textContent = '';
  } catch {
    if (!silent) ss.errorEl.textContent = 'Could not reach tracking endpoint.';
  }
}

function startTracking(sportKey, query) {
  const ss = state.get(sportKey);
  if (!ss) return;
  clearPolling(ss);
  ss.currentQuery         = query;
  ss.scoreEl.hidden       = false;
  ss.statusEl.textContent = 'Loading\u2026';
  ss.clockEl.textContent  = '';
  updateStreamButton(ss, null);
  setActiveChip(sportKey, query);
  
  const poll = async () => {
    if (ss.currentQuery !== query) return;
    await fetchTrack(sportKey, query, true);
    ss.pollTimer = setTimeout(poll, TRACK_POLL_MS);
  };
  
  fetchTrack(sportKey, query, false).then(() => {
    ss.pollTimer = setTimeout(poll, TRACK_POLL_MS);
  });
}

const gameIdentity = (g) => String(g.matchId || g.gameId || g.label || '').trim();

function buildChip(sportKey, game) {
  const live = isLiveStatus(game.status);
  const btn  = document.createElement('button');
  btn.type      = 'button';
  btn.className = `game-chip${live ? ' chip-live' : ''}`;
  btn.dataset.label = game.label;

  let content = '';

  if (live) {
     if (sportKey === 'nba') {
         let clockText = (game.clock || '').trim();
         if (clockText.toLowerCase() === 'live') clockText = '';
         content = clockText ? `${game.label} ${BULLET} ${clockText} ${BULLET} LIVE` : `${game.label} ${BULLET} LIVE`;
     } else {
         const timeStr = game.clock || 'LIVE';
         content = `${game.label} ${BULLET} ${game.status} ${BULLET} ${timeStr}`;
     }
  } else {
     const timeStr = formatPacificTime(game.startTime);
     content = `${game.label} ${BULLET} ${game.status} ${BULLET} ${timeStr}`;
  }

  btn.textContent = content.replace(/\s+/g, ' ').trim();
  btn.addEventListener('click', () => {
    const ss = state.get(sportKey);
    if (ss) ss.input.value = game.label;
    startTracking(sportKey, game.label);
  });
  return btn;
}

async function loadSportData(sportKey) {
  const ss = state.get(sportKey);
  if (!ss) return;
  try {
    const res  = await fetchWithTimeout(`/api/games?sport=${encodeURIComponent(sportKey)}`);
    const data = await safeJson(res);

    if (!res.ok) { ss.helpEl.textContent = data.error || 'Could not load matches.'; return; }
    if (!data.games?.length) { ss.helpEl.textContent = 'No matches found right now.'; return; }

    ss.helpEl.textContent = data.warning ? `Fallback: ${data.warning}` : 'Upcoming in next 12 hours:';

    ss.liveEl.innerHTML     = '';
    ss.upcomingEl.innerHTML = '';
    ss.allEl.innerHTML      = '';

    if (ss.refreshTimeEl) ss.refreshTimeEl.textContent = '';
    updateGlobalRefresh();

    let liveGames     = data.games.filter((g) => isLiveStatus(g.status));
    const upcomingGames = (data.upcoming || []).filter((g) => !isLiveStatus(g.status));
    
    // Sort NBA games by Quarter (Q4 > Q3 > Q2 > Q1)
    if (sportKey === 'nba' && liveGames.length > 0) {
        const getProgress = (c) => {
            let p = 0, t = 0;
            if (/Q1/i.test(c)) p = 1;
            else if (/Q2/i.test(c)) p = 2;
            else if (/Half/i.test(c)) p = 2.5;
            else if (/Q3/i.test(c)) p = 3;
            else if (/Q4/i.test(c)) p = 4;
            else if (/OT(\d*)/i.test(c)) {
                let otMatch = c.match(/OT(\d*)/i);
                p = 4 + (parseInt(otMatch ? otMatch[1] : 1) || 1);
            }
            let m = (c || '').match(/(\d+):(\d+)/);
            if (m) t = parseInt(m[1]) * 60 + parseInt(m[2]);
            return (p * 10000) - t; // Higher period is better, lower time is better
        };
        liveGames.sort((a, b) => getProgress(b.clock || '') - getProgress(a.clock || ''));
    }

        if (liveGames.length) {
      ss.liveHeaderEl.hidden = false;
      if (sportKey === 'nba') {
          ss.liveEl.style.display = 'flex';
          ss.liveEl.style.flexDirection = 'column';
          let currentQuarter = null;
          for (const g of liveGames) {
              let qMatch = (g.clock || '').match(/(Q[1-4]|OT\d*|Half)/i);
              let qLabel = qMatch ? qMatch[1].toUpperCase() : 'OTHER';
              if (qLabel === 'HALF') qLabel = 'HALFTIME';
              
              if (qLabel !== currentQuarter) {
                  const div = document.createElement('div');
                  div.className = 'quarter-divider';
                  div.textContent = qLabel;
                  ss.liveEl.appendChild(div);
                  currentQuarter = qLabel;
              }
              ss.liveEl.appendChild(buildChip(sportKey, g));
          }
      } else {
          for (const g of liveGames) ss.liveEl.appendChild(buildChip(sportKey, g));
      }
    } else {
      ss.liveHeaderEl.hidden = true;
    }

    if (upcomingGames.length) {
      for (const g of upcomingGames) ss.upcomingEl.appendChild(buildChip(sportKey, g));
    } else if (!liveGames.length) {
      const p = document.createElement('p');
      p.className = 'hint';
      p.textContent = 'No matches scheduled in the next 12 hours.';
      ss.upcomingEl.appendChild(p);
    }

    const autoTrack = liveGames[0] || upcomingGames[0];
    if (autoTrack) {
      ss.input.value = autoTrack.label;
      startTracking(sportKey, autoTrack.label);
    }
  } catch {
    ss.helpEl.textContent = 'Could not load matches. Check your API routes.';
  }
}

function mountSportSection(sport) {
  const node = template.content.cloneNode(true);
  const root = node.querySelector('[data-sport-card]');
  root.querySelector('[data-title]').textContent = sport.label;

  const form         = root.querySelector('[data-form]');
  const input        = root.querySelector('[data-input]');
  const helpEl       = root.querySelector('[data-help]');
  const liveHeaderEl = root.querySelector('[data-live-header]');
  const liveEl       = root.querySelector('[data-live]');
  const upcomingEl   = root.querySelector('[data-upcoming]');
  const allEl        = root.querySelector('[data-all]');
  const streamRow    = root.querySelector('[data-stream-row]');
  const streamBtn    = root.querySelector('[data-stream-btn]');
  const scoreEl      = root.querySelector('[data-score]');
  const awayEl       = root.querySelector('[data-away]');
  const homeEl       = root.querySelector('[data-home]');
  const statusEl     = root.querySelector('[data-status]');
  const clockEl      = root.querySelector('[data-clock]');
  const errorEl      = root.querySelector('[data-error]');
  const refreshTimeEl = root.querySelector('[data-refresh-time]');

  streamRow.hidden = true;

  state.set(sport.key, {
    root, form, input, helpEl, liveHeaderEl, liveEl,
    upcomingEl, allEl, streamRow, streamBtn,
    scoreEl, awayEl, homeEl, statusEl, clockEl, errorEl, refreshTimeEl,
    pollTimer: null, currentQuery: ''
  });

  form.addEventListener('submit', (e) => { e.preventDefault(); startTracking(sport.key, input.value); });
  sectionsRoot.appendChild(root);
}

for (const sport of sports) mountSportSection(sport);
for (const sport of sports) loadSportData(sport.key);

initTheme();
themeToggle.addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme') || 'light';
  setTheme(cur === 'light' ? 'dark' : 'light');
});

window.addEventListener('beforeunload', () => {
  for (const ss of state.values()) clearPolling(ss);
});





